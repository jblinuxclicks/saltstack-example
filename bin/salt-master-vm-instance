#!/usr/bin/env bash

# start a CentOS 7 virtual machine instance to host the salt master
virsh-instance shadow --memory 4 centos7 $SALT_MASTER
sleep 15 # wait for the boot

cd $(virsh-instance path $SALT_MASTER)

echo Basic configuration of ${SALT_MASTER}...
ssh-instance --root "
        hostname $SALT_MASTER
        echo $SALT_MASTER > /etc/hostname
        systemctl disable --now firewalld |:
        yum install -e 0 -qy git bash-completion
"

echo Sync repository to $SALT_MASTER
rsync-instance --root $SALT_EXAMPLE_PATH :/opt
ssh-instance --root "echo 'source /opt/${SALT_REPO##*/}/source_me.sh' >> ~/.bashrc"

echo Boostrap the Salt master...
ssh-instance --root '
        cp -v $SALT_EXAMPLE_PATH/etc/yum.repos.d/salt.repo /etc/yum.repos.d/
        yum install --assumeyes epel-release
        yum install --assumeyes salt-minion git bash-completion jq
'

cd - |:
